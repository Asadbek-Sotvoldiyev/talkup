{% extends 'base.html' %}
{% load static %}

{% block title %}
    Chatlar - Talkup
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
    <link href="{% static 'css/chat-list.css' %}" rel="stylesheet">
{% endblock %}

{% block body %}
    <div id="page-loader"
         class="fixed inset-0 z-[9999] flex items-center justify-center bg-slate-100 transition-opacity duration-300">
        <div class="flex flex-col items-center gap-4">
            <div class="relative">
                <div class="w-14 h-14 rounded-2xl bg-slate-900 flex items-center justify-center">
                    <i data-lucide="messages-square" class="w-7 h-7 text-white"></i>
                </div>
                <span class="absolute inset-0 rounded-2xl animate-ping bg-slate-900/30"></span>
            </div>
        </div>
    </div>

    <div class="min-h-screen">
        <div class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
            <div class="mx-auto max-w-5xl px-4 sm:px-6 py-4">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-2xl bg-slate-900 text-white flex items-center justify-center shadow-sm">
                            <i data-lucide="messages-square" class="w-5 h-5"></i>
                        </div>
                        <div class="leading-tight">
                            <div class="text-xl font-semibold tracking-tight text-slate-900">
                                TalkUp
                            </div>

                            <div class="mt-0.5 flex items-center gap-1 text-xs text-slate-500">
                            <span class="font-medium text-slate-600 truncate">
                                {{ user.get_full_name }}
                            </span>

                                {% if user.is_verified %}
                                    <svg class="w-[13px] h-[13px] shrink-0"
                                         viewBox="0 0 24 24"
                                         fill="none">
                                        <circle cx="12" cy="12" r="10" fill="#3390EC"/>
                                        <path d="M8 12.5L10.2 14.7L16 9"
                                              stroke="white"
                                              stroke-width="2"
                                              stroke-linecap="round"
                                              stroke-linejoin="round"/>
                                    </svg>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2">
                            <button
                                    type="button"
                                    id="profileBtn"
                                    class="h-11 px-4 rounded-2xl border border-slate-200 hover:bg-slate-50
           flex items-center gap-2 transition active:scale-[0.98]">
                                <i data-lucide="user" class="w-5 h-5 text-slate-700"></i>
                                <span class="text-sm font-semibold text-slate-700 hidden sm:inline">Profil</span>
                            </button>
                        </div>

                        <form method="post" action="/accounts/logout/">
                            {% csrf_token %}
                            <button
                                    type="submit"
                                    class="h-11 w-11 rounded-2xl border border-slate-200 hover:bg-slate-50 flex items-center justify-center transition active:scale-[0.98]"
                            >
                                <i data-lucide="log-out" class="w-5 h-5 text-slate-700"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                    <i data-lucide="search" class="w-5 h-5"></i>
                  </span>

                        <input
                                id="search"
                                class="w-full pl-10 pr-12 py-3.5 rounded-2xl bg-slate-50 border border-slate-200
                   focus:outline-none focus:ring-4 focus:ring-slate-900/10 focus:border-slate-300 transition"
                                placeholder="Qidirish..."
                                autocomplete="off"
                        />

                        <button
                                id="clearSearch"
                                type="button"
                                class="hidden absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-xl
                   hover:bg-white border border-transparent hover:border-slate-200 text-slate-600
                   flex items-center justify-center transition"
                        >
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                        <div id="searchBox"
                             class="hidden absolute z-50 mt-2 w-full rounded-2xl border border-slate-200 bg-white shadow-lg overflow-hidden">
                            <div id="searchResults" class="max-h-80 overflow-auto soft-scroll"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mx-auto max-w-5xl px-4 sm:px-6 py-3">
            <div id="list" class="soft-scroll space-y-2">
                {% for u in users %}
                    <a
                            href="{% url 'private-chat' u.username %}"
                            class="user-row group flex items-center gap-4 px-3 py-3 rounded-2xl border border-slate-200/70 bg-white
               hover:bg-slate-50 hover:border-slate-300 transition
               {% if u.unread %} ring-1 ring-slate-900/5 {% endif %}"
                            data-name="{{ u.name|lower }} {{ u.username|lower }}"
                            data-online="{% if u.online %}1{% else %}0{% endif %}"
                            data-unread="{% if u.unread %}{{ u.unread }}{% else %}0{% endif %}"
                            data-delete-url="{% url 'chat-delete' u.username %}"
                            data-verified="{% if u.is_verified %}1{% else %}0{% endif %}"
                            data-verify-url="{% url 'toggle-verify' u.username %}"
                    >
                        <div class="relative shrink-0">
                            <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-100
                              border border-slate-200 ring-1 ring-black/5 flex
                              items-center justify-center group-hover:border-slate-300 transition">
                                {% if u.image %}
                                    <img
                                            src="{{ u.image.url }}"
                                            alt="{{ u.first_name }}"
                                            class="w-full h-full object-cover block"
                                    >
                                {% else %}
                                    <span class="text-slate-800 font-semibold">
                        {{ u.name|slice:":1"|upper }}
                      </span>
                                {% endif %}
                            </div>

                            {% if u.online %}
                                <span class="absolute -bottom-1 -right-1 w-4.5 h-4.5 bg-emerald-500 border-[3px] border-white rounded-full"></span>
                            {% endif %}
                        </div>

                        <div class="min-w-0 flex-1">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="flex items-center gap-2 min-w-0">
                                        <div class="flex items-center gap-1 min-w-0">
                                            <div class="truncate text-[15px] leading-5 {% if u.unread %}font-semibold text-slate-900{% else %}font-medium text-slate-700{% endif %}">
                                                {{ u.name }}
                                            </div>

                                            {% if u.is_verified %}
                                                <svg class="w-[14px] h-[14px] shrink-0 block" viewBox="0 0 24 24"
                                                     fill="none"
                                                     aria-hidden="true">
                                                    <circle cx="12" cy="12" r="10" fill="#3390EC"/>
                                                    <path d="M8 12.5L10.2 14.7L16 9" stroke="white" stroke-width="2"
                                                          stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            {% endif %}
                                        </div>

                                        {% if u.online %}
                                            <span class="shrink-0 px-2 py-0.5 rounded-full text-[11px] font-semibold
                             bg-emerald-50 text-emerald-700 border border-emerald-100">
                                  onlayn
                                </span>
                                        {% endif %}
                                    </div>

                                    <div class="mt-0.5 text-sm text-slate-500 truncate">@{{ u.username }}</div>

                                    {% if u.last_message %}
                                        <div class="mt-1 text-sm text-slate-600 truncate">
                                            {{ u.last_message }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="shrink-0 flex items-center gap-2 pt-0.5">
                                    {% if u.unread %}
                                        <span class="min-w-[26px] h-[26px] px-2 rounded-full bg-slate-900 text-white text-xs font-semibold
                           inline-flex items-center justify-center">
                            {{ u.unread }}
                          </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </a>
                {% empty %}
                    <div class="min-h-[60vh] flex items-center justify-center px-4">
                        <div class="text-center max-w-sm w-full">

                            <div class="mx-auto w-20 h-20 rounded-3xl bg-slate-100 border border-slate-200 flex items-center justify-center mb-6 shadow-sm transition hover:scale-105">
                                <i data-lucide="message-circle" class="w-8 h-8 text-slate-500"></i>
                            </div>

                            <div class="text-lg font-semibold text-slate-800">
                                Hozircha chatlar yo‘q
                            </div>

                            <div class="text-sm text-slate-500 mt-2 leading-relaxed">
                                Qidiruvdan foydalanuvchi toping va suhbatni boshlang.
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 z-[60]">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

        <div class="relative min-h-full flex items-center justify-center p-4">
            <div class="w-full max-w-md rounded-3xl bg-white border border-slate-200 shadow-xl overflow-hidden">
                <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-10 h-10 rounded-2xl bg-slate-100 border border-slate-200 flex items-center justify-center">
                            <i data-lucide="id-card" class="w-5 h-5 text-slate-700"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-slate-900">Profil</div>
                            <div class="text-xs text-slate-500">Akkaunt ma’lumotlari</div>
                        </div>
                    </div>

                    <button id="profileClose"
                            class="w-10 h-10 rounded-2xl hover:bg-slate-50 flex items-center justify-center">
                        <i data-lucide="x" class="w-5 h-5 text-slate-700"></i>
                    </button>
                </div>

                <div class="p-4 pt-4">

                    {# VIEW MODE #}
                    <div id="profileViewBox">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-full overflow-hidden bg-slate-100
                                  border border-slate-200 ring-1 ring-black/5 flex
                                  items-center justify-center group-hover:border-slate-300 transition">
                                {% if user.image %}
                                    <img
                                            src="{{ user.image.url }}"
                                            alt="{{ user.first_name }}"
                                            class="w-full h-full object-cover block"
                                    >
                                {% else %}
                                    <span class="text-slate-800 font-semibold">
                            {{ user.first_name|slice:":1"|upper }}
                          </span>
                                {% endif %}
                            </div>

                            <div class="min-w-0 flex-1">
                                <div class="flex items-center justify-between gap-2">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2">
                                            <div class="text-lg font-semibold text-slate-900 truncate">
                                                {{ user.get_full_name }}
                                            </div>

                                            {% if user.is_verified %}
                                                <svg class="w-[16px] h-[16px] shrink-0" viewBox="0 0 24 24" fill="none"
                                                     aria-hidden="true">
                                                    <circle cx="12" cy="12" r="10" fill="#3390EC"/>
                                                    <path d="M8 12.5L10.2 14.7L16 9" stroke="white" stroke-width="2"
                                                          stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            {% endif %}
                                        </div>

                                        <div class="text-sm text-slate-500 truncate">
                                            @{{ user.username }}
                                        </div>
                                    </div>

                                    <button
                                            type="button"
                                            id="profileEditBtnInModal"
                                            class="w-10 h-10 rounded-2xl border border-slate-200 hover:bg-slate-50
                   flex items-center justify-center transition active:scale-[0.98]"
                                    >
                                        <i data-lucide="pencil" class="w-5 h-5 text-slate-700"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-5 space-y-3">
                            <div class="flex items-center justify-between gap-4 px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200">
                                <div class="text-sm text-slate-600 flex items-center gap-2">
                                    <i data-lucide="at-sign" class="w-4 h-4"></i> Foydalanuvchi nomi
                                </div>
                                <div class="text-sm font-semibold text-slate-900 truncate">@{{ user.username }}</div>
                            </div>

                            <div class="flex items-center justify-between gap-4 px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200">
                                <div class="text-sm text-slate-600 flex items-center gap-2">
                                    <i data-lucide="mail" class="w-4 h-4"></i> Elektron pochta
                                </div>
                                <div class="text-sm font-semibold text-slate-900 truncate">
                                    {{ user.email|default:"Topilmadi." }}
                                </div>
                            </div>

                            <div class="flex items-center justify-between gap-4 px-4 py-3 rounded-2xl bg-slate-50 border border-slate-200">
                                <div class="text-sm text-slate-600 flex items-center gap-2">
                                    <i data-lucide="badge-check" class="w-4 h-4"></i> Tasdiqlangan
                                </div>
                                <div class="text-sm font-semibold">
                                    {% if user.is_verified %}
                                        <span class="text-emerald-700">Ha</span>
                                    {% else %}
                                        <span class="text-slate-600">Yo‘q</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mt-5 flex gap-2">
                            <button id="profileOk"
                                    class="flex-1 h-11 rounded-2xl bg-slate-900 text-white font-semibold hover:bg-slate-800 transition active:scale-[0.98]">
                                Tushunarli
                            </button>
                        </div>
                    </div>

                    {# EDIT MODE #}
                    <div id="profileEditBox" class="hidden">
                        <form method="post" action="{% url 'profile-update' %}" enctype="multipart/form-data"
                              class="space-y-4">
                            {% csrf_token %}

                            <!-- Avatar row -->
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 rounded-full overflow-hidden bg-slate-100 border border-slate-200 ring-1 ring-black/5 flex items-center justify-center">
                                    {% if user.image %}
                                        <img id="avatarPreview" src="{{ user.image.url }}" alt="{{ user.first_name }}"
                                             class="w-full h-full object-cover block">
                                    {% else %}
                                        <span id="avatarFallback" class="text-slate-800 font-semibold">
                                    {{ user.first_name|slice:":1"|upper }}
                                </span>
                                    {% endif %}
                                </div>

                                <div class="min-w-0 flex-1">
                                    <div class="text-sm font-semibold text-slate-900">Profil rasmini yangilash</div>

                                    <!-- Hidden real input -->
                                    <input
                                            id="avatarInput"
                                            type="file"
                                            name="image"
                                            accept="image/*"
                                            class="absolute w-[1px] h-[1px] p-0 -m-[1px] overflow-hidden whitespace-nowrap border-0 opacity-0"
                                    />

                                    <!-- Pretty button -->
                                    <div class="mt-2 flex gap-2">
                                        <button type="button" id="avatarPickBtn"
                                                class="h-10 px-4 rounded-2xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800 transition active:scale-[0.98] flex items-center gap-2">
                                            <i data-lucide="upload" class="w-4 h-4"></i>
                                            Tanlash
                                        </button>

                                        <button type="button" id="avatarClearBtn" disabled
                                                class="h-10 px-4 rounded-2xl border border-slate-200 bg-white text-sm font-semibold text-slate-700 hover:bg-slate-50 transition active:scale-[0.98] flex items-center gap-2">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            Tozalash
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="h-px bg-slate-200/70"></div>

                            <!-- Inputs -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <!-- Ism -->
                                <label class="block">
                                    <span class="text-xs font-semibold text-slate-600">Ism</span>
                                    <input
                                            type="text"
                                            name="first_name"
                                            value="{{ form.first_name.value }}"
                                            class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-200
             focus:outline-none focus:ring-4 focus:ring-slate-900/10 focus:border-slate-300 transition"
                                    />
                                </label>

                                <!-- Familiya -->
                                <label class="block">
                                    <span class="text-xs font-semibold text-slate-600">Familiya</span>
                                    <input
                                            type="text"
                                            name="last_name"
                                            value="{{ form.last_name.value }}"
                                            class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-200
             focus:outline-none focus:ring-4 focus:ring-slate-900/10 focus:border-slate-300 transition"
                                    />
                                </label>
                            </div>

                            <!-- Username -->
                            <label class="block mt-3">
                                <span class="text-xs font-semibold text-slate-600">Foydalanuvchi nomi</span>
                                <input
                                        type="text"
                                        name="username"
                                        value="{{ form.username.value }}"
                                        class="mt-1 w-full px-4 py-3 rounded-2xl bg-white border border-slate-200
           focus:outline-none focus:ring-4 focus:ring-slate-900/10 focus:border-slate-300 transition"
                                        required
                                />
                            </label>

                            <div class="pt-1 flex gap-2">
                                <button
                                        type="button"
                                        id="profileEditCancel"
                                        class="flex-1 h-11 rounded-2xl border border-slate-200 bg-white font-semibold text-slate-700
               hover:bg-slate-50 transition active:scale-[0.98]"
                                >
                                    Bekor qilish
                                </button>

                                <button
                                        type="submit"
                                        class="flex-1 h-11 rounded-2xl bg-slate-900 text-white font-semibold
               hover:bg-slate-800 transition active:scale-[0.98]"
                                >
                                    Saqlash
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Crop Modal -->
                <div id="cropModal" class="hidden fixed inset-0 z-[9999]">
                    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>

                    <div class="relative min-h-full flex items-center justify-center p-4">
                        <div class="w-full max-w-2xl rounded-3xl bg-white border border-slate-200 shadow-xl overflow-hidden">

                            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-10 h-10 rounded-2xl bg-slate-100 border border-slate-200 flex items-center justify-center">
                                        <i data-lucide="crop" class="w-5 h-5 text-slate-700"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-slate-900">Rasmni sozlash</div>
                                        <div class="text-xs text-slate-500">Kesing, yaqinlashtiring, joylang</div>
                                    </div>
                                </div>

                                <button id="cropClose" type="button"
                                        class="w-10 h-10 rounded-2xl hover:bg-slate-50 flex items-center justify-center">
                                    <i data-lucide="x" class="w-5 h-5 text-slate-700"></i>
                                </button>
                            </div>

                            <div class="p-5">
                                <div class="rounded-2xl border border-slate-200 bg-slate-50 overflow-hidden">
                                    <div class="w-full h-[380px] bg-slate-100 relative touch-none select-none">
                                        <img id="cropImage" alt="crop" class="block max-w-full select-none"/>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <button id="resetCrop" type="button"
                                            class="w-full h-11 rounded-2xl border border-slate-200 bg-white font-semibold text-slate-700 hover:bg-slate-50 transition active:scale-[0.98] flex items-center justify-center gap-2">
                                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                                        Tiklash
                                    </button>
                                </div>

                                <div class="mt-4 flex gap-2">
                                    <button id="cropCancel" type="button"
                                            class="flex-1 h-11 rounded-2xl border border-slate-200 bg-white font-semibold text-slate-700 hover:bg-slate-50 transition active:scale-[0.98]">
                                        Bekor qilish
                                    </button>

                                    <button id="cropApply" type="button"
                                            class="flex-1 h-11 rounded-2xl bg-slate-900 text-white font-semibold hover:bg-slate-800 transition active:scale-[0.98]">
                                        Saqlash
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="chatDeleteForm" method="post" class="hidden">
        {% csrf_token %}
    </form>

    <div id="chatCtxMenu"
         class="hidden fixed z-[99999] w-max min-w-[180px]
            rounded-xl border border-slate-200/80
            bg-white/95 backdrop-blur-sm shadow-xl overflow-hidden p-1">

        <button type="button" data-action="open"
                class="flex items-center gap-3 w-full px-3 py-2.5
                   text-sm font-medium text-slate-700
                   hover:bg-slate-100 rounded-lg transition">
            <i data-lucide="message-circle" class="w-4 h-4 shrink-0"></i>
            <span>Ochish</span>
        </button>

        {% if user.is_staff %}
            <div class="h-px bg-slate-200/80 mx-2 my-0.5"></div>

            <button type="button" data-action="verify"
                    class="flex items-center gap-3 w-full px-3 py-2.5
                       text-sm font-medium text-slate-700
                       hover:bg-slate-100 rounded-lg transition">
                <i data-lucide="badge-check" class="w-4 h-4 shrink-0"></i>
                <span id="verifyBtnText">Tasdiqlash</span>
            </button>
        {% endif %}

        <div class="h-px bg-slate-200/80 mx-2 my-0.5"></div>

        <button type="button" data-action="delete"
                class="flex items-center gap-3 w-full px-3 py-2.5
                   text-sm font-medium text-rose-500
                   hover:bg-rose-50 rounded-lg transition">
            <i data-lucide="trash-2" class="w-4 h-4 shrink-0"></i>
            <span>O'chirish</span>
        </button>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
    <script defer src="{% static 'js/chat-list.js' %}"></script>

    <script>
        window.addEventListener("load", () => {
            const loader = document.getElementById("page-loader");
            loader.classList.add("opacity-0", "pointer-events-none");
            setTimeout(() => loader.remove(), 300);
        });
    </script>

{% endblock %}

